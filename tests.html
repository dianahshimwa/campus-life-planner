<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Campus Life Planner - Tests</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 2rem;
      background: #f8fafc;
      color: #1e293b;
      line-height: 1.6;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
      color: #2563eb;
    }

    h2 {
      font-size: 1.5rem;
      margin: 2rem 0 1rem;
      color: #1e293b;
    }

    .test-group {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .test-case {
      padding: 0.75rem;
      margin: 0.5rem 0;
      border-left: 4px solid #cbd5e1;
      background: #f8fafc;
      border-radius: 4px;
    }

    .test-case.pass {
      border-color: #16a34a;
      background: #dcfce7;
    }

    .test-case.fail {
      border-color: #dc2626;
      background: #fee2e2;
    }

    .test-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .test-detail {
      font-size: 0.875rem;
      color: #64748b;
      font-family: 'Courier New', monospace;
    }

    .summary {
      background: #2563eb;
      color: white;
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      text-align: center;
    }

    .summary h2 {
      color: white;
      margin: 0 0 0.5rem;
    }

    .stats {
      display: flex;
      justify-content: center;
      gap: 2rem;
      font-size: 1.25rem;
    }

    code {
      background: #f1f5f9;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <h1>Campus Life Planner - Validation Tests</h1>

  <div class="summary" id="summary">
    <h2>Running tests...</h2>
  </div>

  <div id="test-results"></div>

  <script type="module">
    import { validators, validateImportData } from './scripts/validators.js';
    import { testRegexPattern, highlightMatches } from './scripts/search.js';

    const results = [];

    function test(name, fn) {
      try {
        fn();
        results.push({ name, pass: true });
      } catch (error) {
        results.push({ name, pass: false, error: error.message });
      }
    }

    function assert(condition, message) {
      if (!condition) {
        throw new Error(message || 'Assertion failed');
      }
    }

    function assertEquals(actual, expected, message) {
      if (actual !== expected) {
        throw new Error(message || `Expected ${expected}, got ${actual}`);
      }
    }

    // Title validation tests
    test('Title: Valid title passes', () => {
      const result = validators.title.validate('Study for exam');
      assert(result.valid, 'Valid title should pass');
    });
    test('Title: Leading space fails', () => {
      const result = validators.title.validate(' Study for exam');
      assert(!result.valid, 'Title with leading space should fail');
    });
    test('Title: Trailing space fails', () => {
      const result = validators.title.validate('Study for exam ');
      assert(!result.valid, 'Title with trailing space should fail');
    });
    test('Title: Double spaces fail', () => {
      const result = validators.title.validate('Study  for  exam');
      assert(!result.valid, 'Title with double spaces should fail');
    });
    test('Title: Empty string fails', () => {
      const result = validators.title.validate('');
      assert(!result.valid, 'Empty title should fail');
    });

    // Date validation tests
    test('Date: Valid date passes (YYYY-MM-DD)', () => {
      const result = validators.date.validate('2025-10-15');
      assert(result.valid, 'Valid date should pass');
    });
    test('Date: Invalid format fails', () => {
      const result = validators.date.validate('15-10-2025');
      assert(!result.valid, 'Invalid date format should fail');
    });
    test('Date: Invalid date fails (Feb 30)', () => {
      const result = validators.date.validate('2025-02-30');
      assert(!result.valid, 'Invalid date (Feb 30) should fail');
    });
    test('Date: Invalid month fails', () => {
      const result = validators.date.validate('2025-13-01');
      assert(!result.valid, 'Invalid month should fail');
    });

    // Duration validation tests
    test('Duration: Valid integer passes', () => {
      const result = validators.duration.validate('90');
      assert(result.valid, 'Valid duration should pass');
    });
    test('Duration: Valid decimal passes', () => {
      const result = validators.duration.validate('90.5');
      assert(result.valid, 'Valid decimal duration should pass');
    });
    test('Duration: Negative number fails', () => {
      const result = validators.duration.validate('-10');
      assert(!result.valid, 'Negative duration should fail');
    });
    test('Duration: Too many decimals fails', () => {
      const result = validators.duration.validate('90.555');
      assert(!result.valid, 'Duration with 3+ decimals should fail');
    });
    test('Duration: Over 1440 minutes fails', () => {
      const result = validators.duration.validate('1500');
      assert(!result.valid, 'Duration over 1440 should fail');
    });

    // Tag validation tests
    test('Tag: Valid tag passes', () => {
      const result = validators.tag.validate('homework');
      assert(result.valid, 'Valid tag should pass');
    });
    test('Tag: Tag with spaces passes', () => {
      const result = validators.tag.validate('group project');
      assert(result.valid, 'Tag with space should pass');
    });
    test('Tag: Tag with hyphen passes', () => {
      const result = validators.tag.validate('mid-term');
      assert(result.valid, 'Tag with hyphen should pass');
    });
    test('Tag: Tag with numbers fails', () => {
      const result = validators.tag.validate('homework123');
      assert(!result.valid, 'Tag with numbers should fail');
    });
    test('Tag: Tag with special chars fails', () => {
      const result = validators.tag.validate('homework@work');
      assert(!result.valid, 'Tag with special chars should fail');
    });

    // Duplicate words detection
    test('Duplicate Words: Detects duplicate words', () => {
      const result = validators.duplicateWords.validate('study study for exam');
      assert(!result.valid, 'Duplicate consecutive words should be detected');
    });
    test('Duplicate Words: No duplicates passes', () => {
      const result = validators.duplicateWords.validate('study hard for exam');
      assert(result.valid, 'No duplicates should pass');
    });

    // Regex search tests
    test('Regex Search: Valid pattern compiles', () => {
      const result = testRegexPattern('study|homework');
      assert(result.valid, 'Valid regex should compile');
    });
    test('Regex Search: Invalid pattern fails', () => {
      const result = testRegexPattern('(unclosed');
      assert(!result.valid, 'Invalid regex should fail');
    });
    test('Regex Search: Lookahead pattern works', () => {
      const result = testRegexPattern('(?=.*exam)(?=.*math)');
      assert(result.valid, 'Lookahead pattern should compile');
    });
    test('Regex Search: Back-reference pattern works', () => {
      const result = testRegexPattern('\\b(\\w+)\\s+\\1\\b');
      assert(result.valid, 'Back-reference pattern should compile');
    });

    // Highlight matches tests
    test('Highlight: Matches are highlighted', () => {
      const regex = /study/gi;
      const result = highlightMatches('I need to study for the exam', regex);
      assert(result.includes('<mark>'), 'Matches should be wrapped in <mark>');
    });
    test('Highlight: HTML is escaped', () => {
      const regex = /test/i;
      const result = highlightMatches('<script>test<\/script>', regex);
      assert(result.includes('&lt;script&gt;'), 'HTML should be escaped');
    });

    // Import validation tests
    test('Import Validation: Valid data passes', () => {
      const data = [{
        id: 'task_1',
        title: 'Test task',
        dueDate: '2025-10-15',
        duration: 90,
        tag: 'homework',
        notes: '',
        createdAt: '2025-10-07T12:00:00Z',
        updatedAt: '2025-10-07T12:00:00Z'
      }];
      const result = validateImportData(data);
      assert(result.valid, 'Valid import data should pass');
    });
    test('Import Validation: Missing id fails', () => {
      const data = [{
        title: 'Test task',
        dueDate: '2025-10-15',
        duration: 90,
        tag: 'homework',
        createdAt: '2025-10-07T12:00:00Z',
        updatedAt: '2025-10-07T12:00:00Z'
      }];
      const result = validateImportData(data);
      assert(!result.valid, 'Missing id should fail');
    });
    test('Import Validation: Invalid duration fails', () => {
      const data = [{
        id: 'task_1',
        title: 'Test task',
        dueDate: '2025-10-15',
        duration: -10,
        tag: 'homework',
        createdAt: '2025-10-07T12:00:00Z',
        updatedAt: '2025-10-07T12:00:00Z'
      }];
      const result = validateImportData(data);
      assert(!result.valid, 'Negative duration should fail');
    });
    test('Import Validation: Non-array fails', () => {
      const result = validateImportData({ task: 'not an array' });
      assert(!result.valid, 'Non-array should fail');
    });

    // Combined validation tests
    test('ValidateAll: All valid fields pass', () => {
      const data = {
        title: 'Study for exam',
        date: '2025-10-15',
        duration: '90',
        tag: 'homework'
      };
      const result = validators.validateAll(data);
      assert(result.valid, 'All valid fields should pass');
      assertEquals(Object.keys(result.errors).length, 0, 'No errors should exist');
    });
    test('ValidateAll: Multiple errors collected', () => {
      const data = {
        title: '  ',
        date: 'invalid',
        duration: '-10',
        tag: '123'
      };
      const result = validators.validateAll(data);
      assert(!result.valid, 'Invalid data should fail');
      assert(Object.keys(result.errors).length > 0, 'Errors should be collected');
    });

    function renderResults() {
      const container = document.getElementById('test-results');
      container.innerHTML = '';
      const passed = results.filter(r => r.pass).length;
      const failed = results.filter(r => !r.pass).length;
      const total = results.length;

      const summary = document.getElementById('summary');
      summary.innerHTML = `
        <h2>Test Summary</h2>
        <div class="stats">
          <div><strong>${passed}</strong> Passed</div>
          <div><strong>${failed}</strong> Failed</div>
          <div><strong>${total}</strong> Total</div>
        </div>
      `;

      const groups = {
        'Title Validation': [],
        'Date Validation': [],
        'Duration Validation': [],
        'Tag Validation': [],
        'Duplicate Words Detection': [],
        'Regex Search': [],
        'Highlight Matches': [],
        'Import Validation': [],
        'Combined Validation': []
      };

      results.forEach(result => {
        if (result.name.startsWith('Title:')) groups['Title Validation'].push(result);
        else if (result.name.startsWith('Date:')) groups['Date Validation'].push(result);
        else if (result.name.startsWith('Duration:')) groups['Duration Validation'].push(result);
        else if (result.name.startsWith('Tag:')) groups['Tag Validation'].push(result);
        else if (result.name.startsWith('Duplicate Words:')) groups['Duplicate Words Detection'].push(result);
        else if (result.name.startsWith('Regex Search:')) groups['Regex Search'].push(result);
        else if (result.name.startsWith('Highlight:')) groups['Highlight Matches'].push(result);
        else if (result.name.startsWith('Import Validation:')) groups['Import Validation'].push(result);
        else if (result.name.startsWith('ValidateAll:')) groups['Combined Validation'].push(result);
      });

      Object.entries(groups).forEach(([groupName, tests]) => {
        if (tests.length === 0) return;
        const groupDiv = document.createElement('div');
        groupDiv.className = 'test-group';
        groupDiv.innerHTML = `<h2>${groupName}</h2>`;
        tests.forEach(test => {
          const testDiv = document.createElement('div');
          testDiv.className = `test-case ${test.pass ? 'pass' : 'fail'}`;
          testDiv.innerHTML = `
            <div class="test-name">${test.pass ? '✓' : '✗'} ${test.name}</div>
            ${test.error ? `<div class="test-detail">Error: ${test.error}</div>` : ''}
          `;
          groupDiv.appendChild(testDiv);
        });
        container.appendChild(groupDiv);
      });
    }

    renderResults();
  </script>
</body>
</html>